{% extends "inventory/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Minha Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'inventory/css/home.css' %}">
{% endblock %}

{% block content %}


<div class="homepage-wrapper">

    <h1>Bem-vindo ao SmartStock</h1>
    
    <p>Gerencie seus produtos com facilidade!</p>

    <h2>Seus Produtos Cadastrados</h2>

 
        

    <form method="get" class="filtros-form">


        <label> Nome
            <input type="text" name="nome" placeholder="Nome do produto"
                 value="{{ nome|default:'' }}" class="search-input">
                 </label>

                 <label>
                    Pre√ßo m√≠nimo:
                    <div class="price-wrapper">
                        <span class="price-prefix">R$</span>
                        <input 
                            type="text" 
                            id="preco_min"
                            name="preco_min" 
                            inputmode="decimal"
                            pattern="[0-9]+([,\.][0-9]{1,2})?" 
                            placeholder="Ex: 10,00"
                            value="{{ request.GET.preco_min }}">
                    </div>
                </label>
                
                <label>
                    Pre√ßo m√°ximo:
                    <div class="price-wrapper">
                        <span class="price-prefix">R$</span>
                        <input 
                            type="text" 
                            id="preco_max"
                            name="preco_max" 
                            inputmode="decimal"
                            pattern="[0-9]+([,\.][0-9]{1,2})?" 
                            placeholder="Ex: 50,00"
                            value="{{ request.GET.preco_max }}">
                    </div>
                </label>
        
        <label>
            Estoque m√≠nimo:
            <input 
                type="text" 
                name="estoque_min" 
                inputmode="numeric"
                pattern="[0-9]*"
                placeholder="Ex: 5"
                value="{{ request.GET.estoque_min }}">
        </label>
    
            <label>
                Categoria:
                <select name="categoria">
                    <option value="">Todas</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}" {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.category }}
                        </option>
                    {% endfor %}
                </select>
            </label>
        
            <label>
                Subcategoria:
                <select name="subcategoria">
                    <option value="">Todas</option>
                    {% for sub in subcategorias %}
                        <option value="{{ sub.id }}" {% if request.GET.subcategoria == sub.id|stringformat:"s" %}selected{% endif %}>
                            {{ sub.subcategory }}
                        </option>
                    {% endfor %}
                </select>
            </label>
        
            <label>
                Dispon√≠vel:
                <select name="disponivel">
                    <option value="">Todos</option>
                    <option value="sim" {% if request.GET.disponivel == "sim" %}selected{% endif %}>Sim</option>
                    <option value="nao" {% if request.GET.disponivel == "nao" %}selected{% endif %}>N√£o</option>
                </select>
            </label>
        
            <button type="submit">Filtrar</button>
        </form>
        
        


        {% if itens %}
            <ul>
                {% for item in itens %}
                <li>
                    <a href="{% url 'item_details' item.pk %}">
                        <img src="{{ item.images.url }}" alt="Imagem do produto"  class="product-image">
                    
                        <div class="product-info">
                            <h4 class="product-name">{{ item.name }}</h4>
                            
                            <p class="product-price">üí∞ R$ {{ item.price|floatformat:2|intcomma }}</p>
                            <p class="product-stock">üì¶ Estoque: {{ item.quantity }}</p>
                        
                            <div class="product-tags">
                                {% if item.category %}
                                    <span class="tag category">{{ item.category }}</span>
                                {% endif %}
                                {% if item.subcategory %}
                                    <span class="tag subcategory">{{ item.subcategory }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-message">Voc√™ ainda n√£o cadastrou nenhum produto.</p>
        {% endif %}
    </div>


<script>


document.addEventListener("DOMContentLoaded", function () {
    function aplicarMascara(input) {
        if (!input) return;

        input.addEventListener("input", function () {
            let cursorPosition = input.selectionStart;

            // Remove tudo que n√£o for n√∫mero
            let value = input.value.replace(/\D/g, "");

            if (!value) {
                input.value = "";
                return;
            }

            // Converte para n√∫mero e divide por 100 para centavos
            let number = parseFloat(value) / 100;

            // Formata com separador de milhar
            let formatted = number.toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            input.value = formatted;

            // Coloca o cursor no final do input
            input.setSelectionRange(formatted.length, formatted.length);
        });

        // Ao enviar o form, remove formata√ß√£o para backend
        input.form.addEventListener("submit", function () {
            let raw = input.value.replace(/\./g, "").replace(",", ".");
            input.value = raw;
        });
    }

    aplicarMascara(document.getElementById("preco_min"));
    aplicarMascara(document.getElementById("preco_max"));
});

</script>


    {% endblock %}
